#!/usr/bin/env bash
set -e

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                             CONFIGURATION JSON                             â”‚
# â”‚  Edit only the JSON below to declare your variables and sections.          â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
CONFIG_JSON=$(cat <<'EOF'
{
  "variables": [],
  "sections": []
}
EOF
)

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                       DO NOT MODIFY ANYTHING BELOW                         â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Ensure all declared env-vars are set
for v in $(jq -r '.variables[]' <<<"$CONFIG_JSON"); do
  : "${!v:?environment variable $v must be set}"
done

run_section() {
  desc="$1"; cmds="$2"
  echo "ğŸŸ¡ $desc" >&2
  tmp=$(mktemp)
  if ! bash -c "$cmds" >"$tmp" 2>&1; then
    echo "âŒ $desc failed. Output:" >&2
    cat "$tmp" >&2
    exit 1
  fi
  rm -f "$tmp"
}

run_section_parallel() {
  desc="$1"; shift
  echo "ğŸŸ¡ $desc (parallel)" >&2
  tmpfiles=(); pids=()
  for cmd in "$@"; do
    tmp=$(mktemp)
    tmpfiles+=("$tmp")
    bash -c "$cmd" >"$tmp" 2>&1 &
    pids+=("$!")
  done
  for i in "${!pids[@]}"; do
    if ! wait "${pids[i]}"; then
      echo "âŒ $desc failed on: ${!i}" >&2
      cat "${tmpfiles[i]}" >&2
      exit 1
    fi
  done
  rm -f "${tmpfiles[@]}"
}

# Loop through each section
jq -c '.sections[]' <<<"$CONFIG_JSON" | while read -r section; do
  desc=$(jq -r '.desc' <<<"$section")
  if [ "$(jq -r '.parallel // false' <<<"$section")" = "true" ]; then
    mapfile -t cmds < <(jq -r '.cmds[]' <<<"$section")
    run_section_parallel "$desc" "${cmds[@]}"
  else
    cmds=$(jq -r '.cmds | join(" && ")' <<<"$section")
    run_section "$desc" "$cmds"
  fi
done

echo "âœ… Setup Script Complete" >&2
